<?phpClass Image extends CI_Controller {   public $validprefixes;   public $customerDir;   public $campaignDir;   public $homepage;      function __construct()	{	 parent::__construct();	 $this->setValidPrefixes();	 	 $this->customerDir = CUSTOMER_IMAGE_DIR;	 $this->campaignDir = CAMPAIGN_IMAGE_DIR;	 	 // Redirection if not found	 $this->homepage = 'http://www.facebook.com/guinnessindonesia';	}		function setValidPrefixes()	{	      // What are the websites (hostnames) that can use this		  // image?		  // If your site can be accessed with or without the		  // "www" prefix, make sure you put both here. Do not put		  // any trailing slashes ("/") nor any "http://" prefixes.		  // Follow the example below.		  $url_meta = parse_url(base_url());		  $url_meta_no_www = str_replace("www.","",$url_meta['host']);		  $this->validprefixes = array(			$url_meta['host'],			$url_meta_no_www,			'www.facebook.com',			'facebook.com',			'profile.ak.fbcdn.net',					'fbcdn.net',		  );	}		private function isreferrerokay ( $referrer, $validprefixes )	  {		$validreferrer = 0 ;		$authreferrer  = current( $validprefixes );		while ($authreferrer) {		  if (preg_match( "/^https?:\/\/$authreferrer\//i", $referrer ) || 		  preg_match( "/^http?:\/\/$authreferrer\//i", $referrer )		  ) {			$validreferrer = 1 ;			break ;		  }		  $authreferrer = next( $validprefixes );		}		return $validreferrer ;	  }	function index($GID = null,$src = null)	{	  $this->load->model('setting_m');	  		$src = $src ? addslashes(strip_tags($src)) : addslashes(strip_tags($this->input->get('src', TRUE)));		$GID = $GID ? (int) addslashes(strip_tags($GID)) : (int) addslashes(strip_tags($this->input->get('gid', TRUE)));		if(!$src || !$GID) 			header( "HTTP/1.0 404 Not Found" );		 // Where did you actually put your images?		  // Make sure that the path you put below ends with		  // a directory slash ("/"). The script below assumes it.		  $imagedir = $this->customerDir.$GID.'/';		  //----------------------- main program -----------------------		  $image = $src;		  $referrer = getenv( "HTTP_REFERER" );		  if (isset($src)) {			if (empty($referrer) || $this->isreferrerokay( $referrer, $this->validprefixes )) {			  $imagepath = $imagedir . $image ;			  $this->display($imagepath);			}			else {			  header( "HTTP/1.0 404 Not Found" );			}		  }		  else {			header( "Location: ".$this->homepage );		  }	}				function campaign($src = null)	{	  $this->load->model('setting_m');	  		$src = $src ? addslashes(strip_tags($src)) : addslashes(strip_tags($this->input->get('src', TRUE)));		if(!$src) 			header( "HTTP/1.0 404 Not Found" );		 // Where did you actually put your images?		  // Make sure that the path you put below ends with		  // a directory slash ("/"). The script below assumes it.		  $imagedir = CAMPAIGN_IMAGE_DIR.'/';		  //----------------------- main program -----------------------		  $image = $src;		  $referrer = getenv( "HTTP_REFERER" );		  if (isset($src)) {			if (empty($referrer) ||			  $this->isreferrerokay( $referrer, $this->validprefixes )) {			  $imagepath = $imagedir . $image ;			  $this->display($imagepath);			  			}			else {			  header( "HTTP/1.0 404 Not Found" );			}		  }		  else {			header( "Location: ".$this->homepage );		  }	}		protected function display($imagepath){	  $imageinfo = getimagesize( $imagepath );			  if ($imageinfo[2] == 1) {				$imagetype = "gif" ;			  }			  elseif ($imageinfo[2] == 2) {				$imagetype = "jpeg" ;			  }			  elseif ($imageinfo[2] == 3) {				$imagetype = "png" ;			  }			  else {				header( "HTTP/1.0 404 Not Found" );				exit ;			  }			  header( "Content-type: image/$imagetype" );			  @readfile( $imagepath );			  exit;	}	}